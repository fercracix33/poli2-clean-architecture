/**
 * Organization Members Page
 *
 * Displays and manages organization members:
 * - List all members with search and filter
 * - Invite new members (show invite code)
 * - Remove members (with permissions)
 *
 * Created by: UI/UX Expert Agent
 * Date: 2025-10-10
 * Feature: Organizations UI
 */

'use client';

import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { useParams } from 'next/navigation';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { createClient } from '@/lib/supabase';
import { MemberList } from '@/features/organizations/components/MemberList';
import { InviteDialog } from '@/features/organizations/components/InviteDialog';
import { Button } from '@/components/ui/button';
import { Skeleton } from '@/components/ui/skeleton';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { UserPlus, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { listOrganizationMembers, removeOrganizationMember } from '@/features/organizations/use-cases/manageOrganizationMembers';

export default function OrganizationMembersPage() {
  const t = useTranslations('organization.members');
  const tErrors = useTranslations('organization.errors');
  const params = useParams();
  const queryClient = useQueryClient();
  const slug = params.slug as string;

  const [inviteDialogOpen, setInviteDialogOpen] = useState(false);

  // Fetch organization and check permissions
  const { data: orgData, isLoading: isLoadingOrg } = useQuery({
    queryKey: ['organization', slug],
    queryFn: async () => {
      const supabase = await createClient();
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data: org, error } = await supabase
        .from('organizations')
        .select('*')
        .eq('slug', slug)
        .single();

      if (error || !org) throw new Error(tErrors('notFound'));

      // Check user permissions
      const { data: permissions } = await supabase
        .rpc('get_user_permissions', {
          p_user_id: user.id,
          p_organization_id: org.id
        });

      const canManage = permissions?.includes('user.manage') || false;
      const canRead = permissions?.includes('user.read') || false;

      return { organization: org, userId: user.id, canManage, canRead };
    },
  });

  // Fetch members
  const { data: members, isLoading: isLoadingMembers, error: membersError } = useQuery({
    queryKey: ['organization', slug, 'members'],
    queryFn: async () => {
      if (!orgData) return [];

      const supabase = await createClient();
      const { data, error } = await supabase
        .from('organization_members')
        .select(`
          *,
          user_profile:user_profiles(*),
          role:roles(name)
        `)
        .eq('organization_id', orgData.organization.id)
        .order('joined_at', { ascending: false });

      if (error) throw error;
      return data || [];
    },
    enabled: !!orgData?.organization.id && orgData.canRead,
  });

  // Remove member mutation
  const removeMemberMutation = useMutation({
    mutationFn: async ({ memberId, userName }: { memberId: string; userName: string }) => {
      if (!orgData) throw new Error('Organization data not loaded');

      await removeOrganizationMember(
        orgData.organization.id,
        memberId,
        orgData.userId
      );

      return userName;
    },
    onSuccess: (userName) => {
      queryClient.invalidateQueries({ queryKey: ['organization', slug, 'members'] });
      queryClient.invalidateQueries({ queryKey: ['organization', slug, 'memberCount'] });
      toast.success(t('remove.success'), {
        description: `${userName} has been removed from the organization`,
      });
    },
    onError: (error) => {
      toast.error(t('remove.error'), {
        description: error instanceof Error ? error.message : tErrors('unknownError'),
      });
    },
  });

  // Loading state
  if (isLoadingOrg || isLoadingMembers) {
    return (
      <div className="space-y-6 p-6">
        <div className="flex justify-between items-center">
          <div className="space-y-2">
            <Skeleton className="h-8 w-[200px]" />
            <Skeleton className="h-4 w-[300px]" />
          </div>
          <Skeleton className="h-10 w-[140px]" />
        </div>
        <Skeleton className="h-[400px]" />
      </div>
    );
  }

  // Permission denied
  if (orgData && !orgData.canRead) {
    return (
      <div className="p-6">
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>{tErrors('permissionDenied')}</AlertTitle>
          <AlertDescription>
            {tErrors('permissionDenied')}
          </AlertDescription>
        </Alert>
      </div>
    );
  }

  // Error state
  if (membersError || !orgData || !members) {
    return (
      <div className="p-6">
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>{tErrors('loadFailed')}</AlertTitle>
          <AlertDescription>
            {membersError?.message || tErrors('unknownError')}
          </AlertDescription>
        </Alert>
      </div>
    );
  }

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div className="space-y-1">
          <h1 className="text-3xl font-bold tracking-tight">
            {t('title')}
          </h1>
          <p className="text-muted-foreground">
            {t('subtitle')}
          </p>
        </div>
        {orgData.canManage && (
          <Button
            onClick={() => setInviteDialogOpen(true)}
            data-testid="invite-members-button"
          >
            <UserPlus className="h-4 w-4 mr-2" />
            {t('inviteButton')}
          </Button>
        )}
      </div>

      {/* Members List */}
      <MemberList
        members={members}
        currentUserId={orgData.userId}
        canManageMembers={orgData.canManage}
        onRemoveMember={async (memberId, userName) => {
          await removeMemberMutation.mutateAsync({ memberId, userName });
        }}
      />

      {/* Invite Dialog */}
      <InviteDialog
        open={inviteDialogOpen}
        onOpenChange={setInviteDialogOpen}
        inviteCode={orgData.organization.invite_code}
        organizationSlug={orgData.organization.slug}
      />
    </div>
  );
}
